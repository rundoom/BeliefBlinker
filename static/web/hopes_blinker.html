<link rel="stylesheet" type="text/css" href="styles.css">
<body>
<div class="blink_me"></div>
</body>

<script>
    let copyShuffle = it => [...it].sort(() => Math.random() - 0.5);

    const elem = document.querySelector(".blink_me");

    const wordSet = new Set(["вера"]);

    const avalFonts = ["BukhariScript-Regular", "CRL____", "Dobrozrachniy-Regular", "Ekran-font", "FXC", "GUERRILLA-Normal", "Hermann-Gotisch_NormalC", "LATINWID", "LineaturaSemibold", "MADE_TheArtist_Sans_PERSONAL_USE", "NeueMachina-Ultrabold", "Oks_Free", "Peace_Sans", "Perfograma", "POSTER", "PRAGHW3", "ProUN", "Queen_of_Clubs", "RodchenkoCTT_Regular", "Silverfake", "Soyuz_Grotesk_Bold", "Start_Normal", "Stiff_Staff", "TOO"];
    const avalColors = ["FFFF33", "FFFF00", "CCCC00", "FF9900", "FF6600", "FF3300", "FF0000", "FF0033", "FF0066", "FF0099", "FF00CC", "FF00FF", "CC00CC", "CC00FF", "9900FF", "6600FF", "0033FF", "00CCFF", "33FFFF", "33FFCC", "00FF99", "33FF66", "00FF33", "99FF33", "CCFF00", "CCCC33"];
    const wsLocation = `ws://${window.location.host}/msgChannel`;

    let wordCurrentSet = copyShuffle(wordSet);
    let fontsCurrentSet = copyShuffle(avalFonts);
    let colorsCurrentSet = copyShuffle(avalColors);

    setInterval(() => {
        if (wordCurrentSet.length === 0) wordCurrentSet = copyShuffle(wordSet);
        if (fontsCurrentSet.length === 0) fontsCurrentSet = copyShuffle(avalFonts);
        if (colorsCurrentSet.length === 0) colorsCurrentSet = copyShuffle(avalColors);
        elem.style.fontFamily = fontsCurrentSet.pop();
        elem.style.color = colorsCurrentSet.pop();
        elem.innerText = wordCurrentSet.pop();
    }, 429);

    let timerID = 0;

    start(wsLocation);

    function start(websocketServerLocation) {
        let socket = new WebSocket(websocketServerLocation);

        socket.addEventListener('open', () => {
            fetch("/initContent").then(it => it.json().then(text => text.forEach(it => wordSet.add(it))));
            if (window.timerID) {
                window.clearInterval(window.timerID);
                window.timerID = 0;
            }
            socket.send('startReceiving');
        });

        socket.addEventListener('message', event => {
            wordSet.push(event.data);
            wordCurrentSet.push(event.data);
        });

        socket.addEventListener('close', () => {
            if (!window.timerID) {
                window.timerID = setInterval(function () {
                    start(wsLocation)
                }, 5000);
            }
        })
    }
</script>